<!DOCTYPE html>
<html lang="en" data-theme="system">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Assistant GitOps Bridge</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@primer/css@21.0.7/dist/primer.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link rel="stylesheet" href="/static/app.css" />
</head>
<body>
  <div class="app-shell">
    <header class="app-bar">
      <div class="app-brand">
        <div class="brand-mark">HA</div>
        <div>
          <div class="brand-title">GitOps Bridge</div>
          <div class="brand-subtitle">Configuration control for Home Assistant</div>
        </div>
      </div>
      <nav class="tab-strip" role="tablist">
        <button class="tab-btn is-active" data-tab="status" aria-controls="tab-status">Status</button>
        <button class="tab-btn" data-tab="git" aria-controls="tab-git">Git</button>
        <button class="tab-btn" data-tab="history" aria-controls="tab-history">History</button>
        <button class="tab-btn" data-tab="modules" aria-controls="tab-modules">YAML Modules</button>
      </nav>
      <button class="tab-btn icon-btn" data-tab="settings" aria-controls="tab-settings" aria-label="Settings">
        <span class="material-symbols-outlined">settings</span>
      </button>
    </header>

    <main class="app-content">
      <section id="tab-status" class="tab-panel is-active" role="tabpanel">
        <div class="status-grid">
          <div class="card">
            <div class="card-header">Current State</div>
            <div id="status-summary" class="summary-grid"></div>
            <div class="card-actions">
              <button id="status-refresh" class="btn">Refresh</button>
              <button id="remote-refresh" class="btn">Check Remote</button>
            </div>
            <div id="status-message" class="note"></div>
          </div>
          <div class="card">
            <div class="card-header">Operator Overview</div>
            <p class="note">
              Status is the system landing page. Use Git for working tree diffs, staging, and commits.
              Use History to review branches, commits, and switch state. Use YAML Modules for module sync.
            </p>
          </div>
        </div>
      </section>

      <section id="tab-git" class="tab-panel" role="tabpanel">
        <div class="status-grid">
          <div class="card">
            <div class="card-header">Commit & Sync</div>
            <label>Commit message</label>
            <input type="text" id="commit-message" placeholder="Describe your change" />
            <div class="button-row">
              <button id="commit-staged" class="btn">Commit staged</button>
              <button id="commit-all" class="btn btn-primary">Commit all</button>
            </div>
            <div class="button-row">
              <button id="pull-btn" class="btn">Pull</button>
              <button id="push-btn" class="btn">Push</button>
            </div>
            <div id="commit-status" class="note"></div>
          </div>
          <div class="card">
            <div class="card-header">Working Tree Checklist</div>
            <p class="note">
              Stage changes, review diffs, then commit and push. Use History to inspect prior commits.
            </p>
          </div>
        </div>

        <div class="card diff-toolbar">
          <div class="card-header">Working Tree Diffs</div>
          <div class="toolbar-row">
            <div id="diff-mode" class="segmented" role="tablist">
              <button class="segmented-btn is-active" data-mode="all">All</button>
              <button class="segmented-btn" data-mode="staged">Staged</button>
              <button class="segmented-btn" data-mode="unstaged">Unstaged</button>
            </div>
            <div class="button-row">
              <button id="stage-all" class="btn">Stage all</button>
              <button id="unstage-all" class="btn">Unstage all</button>
            </div>
          </div>
          <div id="diff-list" class="diff-list"></div>
        </div>
      </section>

      <section id="tab-history" class="tab-panel" role="tabpanel">
        <div class="git-grid">
          <aside class="card branch-card">
            <div class="card-header">Branches</div>
            <label>Select branch</label>
            <select id="branch-select"></select>
            <div id="commit-list" class="commit-list"></div>
          </aside>
          <section class="card commit-card">
            <div class="commit-header">
              <div>
                <div class="card-header">Commit History</div>
                <div id="commit-meta" class="note">Select a commit to inspect its diff.</div>
              </div>
              <button id="reset-commit" class="btn btn-danger" disabled>
                Set state to this commit
              </button>
            </div>
            <div id="commit-diffs" class="diff-list"></div>
          </section>
        </div>
      </section>

      <section id="tab-modules" class="tab-panel" role="tabpanel">
        <div class="git-grid modules-grid">
          <aside class="card module-sidebar">
            <div class="card-header">Module Browser</div>
            <p class="note">
              Browse YAML Modules by package name (<code>packages/&lt;name&gt;/</code>) or domain
              folders (<code>automations/</code>, <code>scripts/</code>, <code>scenes/</code>,
              <code>templates/</code>, <code>helpers/</code>, <code>lovelace/</code>). UI-created
              entries land in <code>*.unassigned.yaml</code>. Sync after edits to rebuild domain
              files.
            </p>
            <label for="module-select">Select module</label>
            <select id="module-select"></select>
            <div id="module-file-list" class="commit-list"></div>
            <div class="module-sidebar-footer">
              <p id="modules-status" class="note"></p>
              <div class="button-row">
                <button id="modules-sync-btn" class="btn btn-primary">Sync modules</button>
              </div>
            </div>
          </aside>
          <section class="card module-editor-card">
            <div class="commit-header module-editor-header">
              <div>
                <div class="card-header">Module File</div>
                <div id="module-file-meta" class="note">Select a module file to inspect and edit.</div>
              </div>
              <div class="button-row">
                <button id="module-save-btn" class="btn btn-primary" disabled>Save file</button>
                <button id="module-delete-btn" class="btn btn-danger" disabled>Delete file</button>
              </div>
            </div>
            <div id="module-editor" class="module-editor">
              <div class="module-editor-placeholder">Select a module file to start editing.</div>
            </div>
            <div id="module-editor-status" class="note"></div>
          </section>
        </div>
      </section>

      <section id="tab-settings" class="tab-panel" role="tabpanel">
        <div class="settings-grid">
          <div class="card">
            <div class="card-header">Settings</div>
            <p class="note">
              Settings are saved to <code>.gitops/config.yaml</code>. Restart the add-on to apply backend
              changes. Theme updates apply immediately. YAML Modules live in the YAML Modules tab.
            </p>
            <label>Remote URL</label>
            <input type="text" id="config-remote-url" placeholder="git@github.com:user/ha-config.git" />
            <label>Remote branch</label>
            <input type="text" id="config-remote-branch" placeholder="main" />
            <label>Git user name</label>
            <input type="text" id="config-git-user-name" placeholder="Home Assistant" />
            <label>Git user email</label>
            <input type="text" id="config-git-user-email" placeholder="home@assistant.local" />
            <label>Webhook path</label>
            <input type="text" id="config-webhook-path" placeholder="pull" />
            <label>Poll interval minutes</label>
            <input type="text" id="config-poll-interval" placeholder="15" />
            <label>Theme</label>
            <select id="config-ui-theme">
              <option value="system">System</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
            <div class="toggle-grid">
              <label><input type="checkbox" id="config-notifications" /> Enable notifications</label>
              <label><input type="checkbox" id="config-webhook-enabled" /> Enable webhook</label>
              <label><input type="checkbox" id="config-yaml-modules" /> Enable YAML Modules</label>
            </div>
            <p class="note">Git user name and email are stored in the repo config used for commits.</p>
            <button id="save-config" class="btn btn-primary">Save configuration</button>
            <div id="config-status" class="note"></div>
          </div>

          <div class="card">
            <div class="card-header">SSH Keys</div>
            <p class="note">SSH keys live in <code>/config/.ssh</code>.</p>
            <div id="ssh-status" class="note"></div>
            <div class="button-row">
              <button id="ssh-generate-btn" class="btn">Generate keypair</button>
              <button id="ssh-load-btn" class="btn">Load public key</button>
              <button id="ssh-test-btn" class="btn">Test SSH connection</button>
            </div>
            <pre id="ssh-public-key"></pre>
            <div id="ssh-instructions" class="note"></div>
            <div id="ssh-test-status" class="note"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
    window.MONACO_BASE = "https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min";
    window.MonacoEnvironment = {
      getWorkerUrl: function () {
        const proxy = [
          "self.MonacoEnvironment = { baseUrl: '" + window.MONACO_BASE + "/' };",
          "importScripts('" + window.MONACO_BASE + "/vs/base/worker/workerMain.js');",
        ].join("\n");
        return "data:text/javascript;charset=utf-8," + encodeURIComponent(proxy);
      },
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
  <script src="/static/app.js"></script>
</body>
</html>
