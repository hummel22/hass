blueprint:
  name: Auto-lock door after duration (notify on success, open, or failure)
  description: >
    When the selected lock has been UNLOCKED for the chosen duration, lock it
    only if the contact sensor is CLOSED. Notify on successful lock, when
    locking is skipped because the door is open, or when the lock fails to
    confirm 'locked' within a timeout.
  domain: automation
  input:
    lock_entity:
      name: Door lock
      selector:
        entity:
          domain: lock
    contact_entity:
      name: Door contact sensor
      description: Usually 'off' = closed, 'on' = open.
      selector:
        entity:
          domain: binary_sensor
          device_class: door
    unlock_duration:
      name: Time unlocked before auto-lock
      default: 00:05:00
      selector:
        duration:
    confirm_timeout:
      name: Lock confirmation timeout
      description: How long to wait for the lock to report "locked" before considering it a failure.
      default: 00:00:20
      selector:
        duration:
    notify_service:
      name: Notify service (required)
      description: e.g. notify.mobile_app_fold_6
      selector:
        text:

    # Success (locked) notification
    notify_title_success:
      name: Success title
      default: "🔒 Door auto-locked"
      selector:
        text:
    notify_message_success:
      name: Success message
      default: "The door was left unlocked. Backup auto-lock engaged."
      selector:
        text:

    # Open (skipped) notification
    notify_title_open:
      name: Open/Skipped title
      default: "⚠️ Auto-lock failed: Door is open"
      selector:
        text:
    notify_message_open:
      name: Open/Skipped message
      default: "The door is open, cannot auto-lock."
      selector:
        text:

    # Failure to confirm locked (mechanical/jam/battery) notification
    notify_title_failed:
      name: Lock confirmation failed title
      default: "⚠️ Auto-lock failed: lock error"
      selector:
        text:
    notify_message_failed:
      name: Lock confirmation failed message
      default: "Door lock never reported 'locked'. Check the lock (jam/low battery?)."
      selector:
        text:

mode: restart

trigger:
  - platform: state
    entity_id: !input lock_entity
    to: "unlocked"
    for: !input unlock_duration

condition: []

action:
  - choose:
      # ✅ Door is CLOSED -> try to lock it
      - conditions:
          - condition: state
            entity_id: !input contact_entity
            state: "off"    # 'off' = closed for most door contacts
        sequence:
          - service: lock.lock
            target:
              entity_id: !input lock_entity

          # Wait for the lock to actually report "locked"
          - wait_for_trigger:
              - platform: state
                entity_id: !input lock_entity
                to: "locked"
            timeout: !input confirm_timeout
            continue_on_timeout: true

          # Notify based on result:
          - choose:
              # Success path: lock confirmed
              - conditions:
                  - condition: template
                    value_template: "{{ wait.completed }}"
                sequence:
                  - service: !input notify_service
                    data:
                      title: !input notify_title_success
                      message: !input notify_message_success
            # Failure path: lock did not confirm
            default:
              - service: !input notify_service
                data:
                  title: !input notify_title_failed
                  message: !input notify_message_failed

    # ❌ Door is OPEN -> notify (no lock attempt)
    default:
      - service: !input notify_service
        data:
          title: !input notify_title_open
          message: !input notify_message_open
